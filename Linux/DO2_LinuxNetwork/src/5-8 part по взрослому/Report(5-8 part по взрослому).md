## Part 5. Статическая маршрутизация сети

#### 5.1. Настройка адресов машин

1. Конфигурация ws11

   ![1686649689830](image/Report/1686649689830.png)

```yaml
network:
  ethernets:
    enp0s3:
      dhcp4: true
      dhcp4-overrides:
        use-routes: false
    enp0s8:
      addresses: [10.10.0.2/18]
      match:
        macaddress: 08:00:27:2a:57:32
      set-name: eth0
      dhcp4: false
  version: 2

```

2. Конфигурация r1
   ![1686649762633](image/Report/1686649762633.png)

```yaml
network:
  ethernets:
    enp0s3:
      dhcp4: true
      dhcp4-overrides:
        use-routes: false
    enp0s8:
      addresses: [10.10.0.1/18]
      match:
        macaddress: 08:00:27:5a:90:01
      set-name: eth0
      dhcp4: false
    enp0s9:
      addresses: [10.100.0.11/16]
      match:
        macaddress: 08:00:27:fb:cb:2d
      set-name: eth1
      dhcp4: false
  version: 2
```

3. Конфигурация r2
   ![1686649824939](image/Report/1686649824939.png)

   ```
   # This is the network config written by 'subiquity'
   network:
     ethernets:
       enp0s3:
         dhcp4: true
       enp0s8:
         addresses: [10.100.0.12/16]
         match:
           macaddress: 08:00:27:71:d9:43
         set-name: eth0
         dhcp4: false
       enp0s9:
         addresses: [10.20.0.1/26]
         match:
           macaddress: 08:00:27:31:02:ba
         set-name: eth1
         dhcp4: false
     version: 2
   ```
4. Конфигурация ws21

   ![1686649893305](image/Report/1686649893305.png)

   ```yaml
   network:
     ethernets:
       enp0s3:
         dhcp4: true
         dhcp4-overrides:
           use-routes: false
       enp0s8:
         addresses: [10.20.0.10/26]
         match:
           macaddress: 08:00:27:d4:14:b6
         set-name: eth0
         dhcp4: false
     version: 2

   ```
5. Конфигурация ws22

   ![1686649865825](image/Report/1686649865825.png)

   ```yaml
   # This is the network config written by 'subiquity'
   network:
     ethernets:
       enp0s3:
         dhcp4: true
         dhcp4-overrides:
           use-routes: false
       enp0s8:
         addresses: [10.20.0.10/26]
         match:
           macaddress: 08:00:27:f7:2d:8c
         set-name: eth0
         dhcp4: false
     version: 2

   ```

##### Ping r1 с ws11

```
ping -c 3  10.10.0.1
```

![1686650028267](image/Report/1686650028267.png)

![](file:///Users/gulianbo/.TemporaryItems/folders.1019979/TemporaryItems/NSIRD_screencaptureui_JlkbBf/%D0%A1%D0%BD%D0%B8%D0%BC%D0%BE%D0%BA%20%D1%8D%D0%BA%D1%80%D0%B0%D0%BD%D0%B0%202023-06-13%20%D0%B2%2012.54.58%20PM.png)![1686650117247](image/Report/1686650117247.png)![](file:///Users/gulianbo/.TemporaryItems/folders.1019979/TemporaryItems/NSIRD_screencaptureui_JlkbBf/%D0%A1%D0%BD%D0%B8%D0%BC%D0%BE%D0%BA%20%D1%8D%D0%BA%D1%80%D0%B0%D0%BD%D0%B0%202023-06-13%20%D0%B2%2012.54.58%20PM.png)

##### Ping ws22 с ws21

![1686650161985](image/Report/1686650161985.png)

#### 5.2. Включение переадресации IP-адресов.

##### Для включения переадресации IP, выполните команду на роутерах:

`sysctl -w net.ipv4.ip_forward=1` *При таком подходе переадресация не будет работать после перезагрузки системы.*

![1686650444312](image/Report/1686650444312.png)

![1686650515034](image/Report/1686650515034.png)

##### Откройте файл */etc/sysctl.conf* и добавьте в него следующую строку:

`net.ipv4.ip_forward = 1` *При использовании этого подхода, IP-переадресация включена на постоянной основе.*

![1686650600996](image/Report/1686650600996.png)

![1686650663699](image/Report/1686650663699.png)

### 5.3. Установка маршрута по-умолчанию

Пример вывода команды `ip r` после добавления шлюза:

```
default via 10.10.0.1 dev eth0
10.10.0.0/18 dev eth0 proto kernel scope link src 10.10.0.2
```

##### Настроить маршрут по-умолчанию (шлюз) для рабочих станций. Для этого добавить `default` перед IP роутера в файле конфигураций

Ws11:

![1686651502992](image/Report/1686651502992.png)

Ws21:

![1686651547788](image/Report/1686651547788.png)

Ws22:

![1686651532340](image/Report/1686651532340.png)

##### Пропинговать с ws11 роутер r2 и показать на r2, что пинг доходит. Для этого использовать команду:

`tcpdump -tn -i eth0`

![1686652160974](image/Report/1686652160974.png)

![1686652185026](image/Report/1686652185026.png)

#### 5.4. Добавление статических маршрутов

##### Добавить в роутеры r1 и r2 статические маршруты в файле конфигураций. Пример для r1 маршрута в сетку 10.20.0.0/26:

```shell
# Добавить в конец описания сетевого интерфейса eth1:
- to: 10.20.0.0
  via: 10.100.0.12
```

R1:

![1686653661833](image/Report/1686653661833.png)

R2:

![1686652978177](image/Report/1686652978177.png)

##### Запустить команды на ws11:

`ip r list 10.10.0.0/[маска сети]` и `ip r list 0.0.0.0/0`

![1686653133115](image/Report/1686653133115.png)

* Для адреса 10.10.0.0/[маска сети] был выбран маршрут eth0 так как этот Ip вполне мог принадлежать одному из хостов подсети и выход из нее не требуется.
* Для адреса 0.0.0.0/0 был выбран маршрут по умолччанию так как он не принажлежит подсети 10.10.0.0/[18] и, следовательно, идет в шлюз, чтобы через маршрутизаторы найти путь.

### 5.5. Построение списка маршрутизаторов

Пример вывода утилиты **traceroute** после добавления шлюза:

![1686659637991](image/Report/1686659637991.png)

##### Запустить на r1 команду дампа:

`tcpdump -tnv -i eth0`

##### При помощи утилиты **traceroute** построить список маршрутизаторов на пути от ws11 до ws21

* В отчёт поместить скрины с вызовом и выводом использованных команд (tcpdump и traceroute).

  ```
  sudo tcpdump -tnv -i eth0 >> traceroute.txt
  ```

  ![1686659522291](image/Report/1686659522291.png)
* ![1686659535021](image/Report/1686659535021.png)
* ![1686659549678](image/Report/1686659549678.png)
* ![1686659571681](image/Report/1686659571681.png)
* В отчёте, опираясь на вывод, полученный из дампа на r1, объяснить принцип работы построения пути при помощи  **traceroute** .

Принцип работы построения пути при помощи  **traceroute** .

Первоначальный хост, с которого запускается команда, отправляет серию пакетов с TTL = 1. TTL - время жизни пакета, характеризующееся количеством хостов, через которое должен пройти пакет, прежде чем будет удалён.

Первый пакет отправляется с TTL = 1, достигая первого маршрутизатора, он будет уничтожен, и маршрутизатор отправляет ICMP-сообщение: "time exceeded in-transit". Получив подобное сообщение сообщение, traceroute увеличивает ttl следующих пакетов на 1.

Каждый раз отправляется по три пакета и для каждого из них измеряется время прохождения. Пакет отправляется на случайный порт, который, скорее всего, не занят. Когда утилита traceroute получает сообщение от целевого узла о том, что порт недоступен трассировка считается завершенной.

Таким образом он может отследить каждый узел задействованный в передаче пакета от 1 хоста к 2.

#### 5.6. Использование протокола **ICMP** при маршрутизации

##### Запустить на r1 перехват сетевого трафика, проходящего через eth0 с помощью команды:

`tcpdump -n -i eth0 icmp`

##### Пропинговать с ws11 несуществующий IP (например,  *10.30.0.111* ) с помощью команды:

`ping -c 2 10.30.0.11`

![1686659739826](image/Report/1686659739826.png)

![1686659747805](image/Report/1686659747805.png)

## Part 6. Динамическая настройка IP с помощью **DHCP**Для r2 настроить в файле */etc/dhcp/dhcpd.conf* конфигурацию службы  **DHCP** :

##### Для r2 настроить в файле */etc/dhcp/dhcpd.conf* конфигурацию службы  **DHCP** :

##### 1) указать адрес маршрутизатора по-умолчанию, DNS-сервер и адрес внутренней сети. Пример файла для r2:

![1686673242695](image/Report/1686673242695.png)

```shell
subnet 10.100.0.0 netmask 255.255.0.0 {}

subnet 10.20.0.0 netmask 255.255.255.192
{
    range 10.20.0.2 10.20.0.50;
    option routers 10.20.0.1;
    option domain-name-servers 10.20.0.1;
}
```

##### 2) в файле *resolv.conf* прописать `nameserver 8.8.8.8.`

![1686673256325](image/Report/1686673256325.png)

##### Перезагрузить службу **DHCP** командой `systemctl restart isc-dhcp-server`. Машину ws21 перезагрузить при помощи `reboot` и через `ip a` показать, что она получила адрес. Также пропинговать ws22 с ws21.

![1686674000984](image/Report/1686674000984.png)

![1686674037488](image/Report/1686674037488.png)eth0 global dynamic - говорит о наличии динамического IP

##### Указать MAC адрес у ws11, для этого в *etc/netplan/00-installer-config.yaml* надо добавить строки: `macaddress: 10:10:10:10:10:BA`, `dhcp4: true`

![1686725788462](image/Report/1686725788462.png)

![1686725802742](image/Report/1686725802742.png)

##### Для r1 настроить аналогично r2, но сделать выдачу адресов с жесткой привязкой к MAC-адресу (ws11). Провести аналогичные тесты

![1686675813257](image/Report/1686675813257.png)

![1686675890958](image/Report/1686675890958.png)

![1686726449513](image/Report/1686726449513.png)

##### Запросить с ws21 обновление ip адtcpреса

```
sudo dhclient -r eth0
sudo dhclient eth0
```

![1686676902666](image/Report/1686676902666.png)

* В отчёте поместить скрины ip до и после обновления.
* В отчёте описать, какими опциями **DHCP** сервера пользовались в данном пункте.

##### Сохранить дампы образов виртуальных машин

**p.s. Ни в коем случае не сохранять дампы в гит!**

## Part 7. **NAT**

`-` Ну и, наконец, в качестве вишенки на торте, я расскажу тебе про механизм преобразования адресов.

**== Задание ==**

*В данном задании используются виртуальные машины из Части 5*

##### В файле */etc/apache2/ports.conf* на ws22 и r1 изменить строку `Listen 80` на `Listen 0.0.0.0:80`, то есть сделать сервер Apache2 общедоступным

![1686751760797](image/Report/1686751760797.png)

![1686751784277](image/Report/1686751784277.png)

Запустить веб-сервер Apache командой `service apache2 start` на ws22 и r1

![1686751820874](image/Report/1686751820874.png)

![1686751829499](image/Report/1686751829499.png)

##### Добавить в фаервол, созданный по аналогии с фаерволом из Части 4, на r2 следующие правила:

##### 1) Удаление правил в таблице filter - `iptables -F`

##### 2) Удаление правил в таблице "NAT" - `iptables -F -t nat`

##### 3) Отбрасывать все маршрутизируемые пакеты - `iptables --policy FORWARD DROP`

##### Запускать файл также, как в Части 4

![1686826289592](image/Report/1686826289592.png)

##### Проверить соединение между ws22 и r1 командой `ping`

*При запуске файла с этими правилами, ws22 не должна "пинговаться" с r1*

![1686826435043](image/Report/1686826435043.png)

##### Добавить в файл ещё одно правило:

##### 4) Разрешить маршрутизацию всех пакетов протокола **ICMP**

##### Запускать файл также, как в Части 4

##### Проверить соединение между ws22 и r1 командой `ping`

*При запуске файла с этими правилами, ws22 должна "пинговаться" с r1*

![1686826481559](image/Report/1686826481559.png)

![1686826533146](image/Report/1686826533146.png)

Добавить в файл ещё два правила:

##### 5) Включить  **SNAT** , а именно маскирование всех локальных ip из локальной сети, находящейся за r2 (по обозначениям из Части 5 - сеть 10.20.0.0)

##### 6) Включить **DNAT** на 8080 порт машины r2 и добавить к веб-серверу Apache, запущенному на ws22, доступ извне сети

![1686826703413](image/Report/1686826703413.png)

##### Проверить соединение по TCP для  **SNAT** , для этого с ws22 подключиться к серверу Apache на r1 командой:

`telnet [адрес] [порт]`

![1686826899514](https://file+.vscode-resource.vscode-cdn.net/Users/gulianbo/Desktop/Linux%20%D0%BF%D0%B5%D1%80%D0%B5%D0%B4%D0%B5%D0%BB%D1%8B%D0%B2%D0%B0%D0%B5%D0%BC/d02_linuxnetwork-1/src/image/Report/1686826899514.png)

##### Проверить соединение по TCP для  **DNAT** , для этого с r1 подключиться к серверу Apache на ws22 командой `telnet` (обращаться по адресу r2 и порту 8080)

![1686827499350](image/Report/1686827499350.png)

## Part 8. Дополнительно. Знакомство с **SSH Tunnels**

Запустить на r2 фаервол с правилами из Части 7

##### Запустить веб-сервер **Apache** на ws22 только на localhost (то есть в файле */etc/apache2/ports.conf* изменить строку `Listen 80` на `Listen localhost:80`)

##### Воспользоваться *Local TCP forwarding* с ws21 до ws22, чтобы получить доступ к веб-серверу на ws22 с ws21

```
ssh -L local_port:remote_host:remote_port user@intermediate_machine
```

* `локальный_порт`: Порт на вашей локальной машине, куда вы хотите получать перенаправленный трафик.
* `удаленный_хост`: Адрес или имя хоста удаленного сервера, к которому вы хотите подключиться.
* `удаленный_порт`: Порт на удаленном сервере, где запущена служба.
* `пользователь`: Ваше имя пользователя на промежуточном компьютере.
* `промежуточный_компьютер`: Адрес или имя хоста машины, которая будет использоваться в качестве прокси.

```
ssh -L 8080:127.0.0.1:80 g@10.20.0.2
или
ssh -L 8080:localhost:80 g@10.20.0.2

```

Команда на ws21:

![1686849807757](image/Report/1686849807757.png)

Подключение на ws21:

![1686849650300](image/Report/1686849650300.png)

##### Воспользоваться *Remote TCP forwarding* c ws11 до ws22, чтобы получить доступ к веб-серверу на ws22 с ws11

```
ssh -R remote_port:local_host:local_port user@intermediate_computer
```

* `удаленный_порт`: Порт на промежуточном компьютере, на котором будет приниматься перенаправленный трафик.
* `локальный_хост`: Адрес или имя хоста локального сервера, к которому вы хотите подключиться.
* `локальный_порт`: Порт на локальном сервере, где работает сервис.
* `пользователь`: Ваше имя пользователя на промежуточном компьютере.
* `промежуточный_компьютер`: Адрес или имя хоста машины, которая будет использоваться в качестве прокси.

```
ssh -R 8080:localhost:80  g@10.10.0.60
```

### Ремарка:

Из-за политики и параноидальнсоти фаерволла на r2 пакеты tcp с r1 и ws22 будут DROP.

*Для этого так же добавить правило для цепочки транзитных пакетов к iptables на r2:*

![1691398954669](image/Report/1691398954669.png)

Если все сделано правильно, топакеты ssh-тунеллирования будут доходить и можно продолжать.

Команда на ws22:

![1686850162967](image/Report/1686850162967.png)

Подключения на ws11:

![1686850148932](image/Report/1686850148932.png)

Покдключение к apache2:

![1686850701959](image/Report/1686850701959.png)

![1686850260199](image/Report/1686850260199.png)
